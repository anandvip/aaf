<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>India â€¢ States â†’ Districts â†’ Tehsils â†’ Villages (Fixed Layout)</title>
<style>
  :root{
    --bg:#0b1323; --panel:#0f1a30; --text:#e6ecff; --muted:#90a3c0;
    --link:#64a5ff; --node:#9fd1ff; --accent:#7bd389;
  }
  html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
  header{position:fixed;left:12px;top:12px;z-index:5;background:linear-gradient(180deg,rgba(255,255,255,.07),rgba(255,255,255,.03));
    border:1px solid rgba(255,255,255,.08);backdrop-filter:blur(6px);padding:10px 12px;border-radius:14px}
  header h1{margin:0 0 6px;font-size:16px}
  header p{margin:0;color:var(--muted);max-width:55ch}
  .toolbar{position:fixed;right:12px;top:12px;z-index:5;display:flex;gap:8px}
  .btn{background:var(--panel);color:var(--text);border:1px solid rgba(255,255,255,.08);padding:8px 10px;border-radius:10px;cursor:pointer}
  .hint{position:fixed;right:12px;bottom:12px;color:var(--muted);background:var(--panel);padding:6px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.08)}
  svg{width:100vw;height:100vh;display:block}
  .link{fill:none;stroke:var(--link);stroke-opacity:.85;stroke-width:2.5;filter:drop-shadow(0 0 3px rgba(100,165,255,0.4))}
  .node circle{fill:var(--node);stroke:rgba(255,255,255,.35);stroke-width:.6;transition:r .2s}
  .node:hover circle{r:18}
  .node text{font-size:14px;fill:var(--text);paint-order:stroke;stroke:#000;stroke-width:2.5;stroke-opacity:.4}
  .badge{font-size:11px;fill:var(--muted)}
  .collapsed-indicator{fill:rgba(255,255,255,.95);font-size:14px;font-weight:bold}
  .external-link{fill:#ffcc00;font-weight:bold}
</style>
</head>
<body>
<header>
  <h1>Hierarchical Explorer â€¢ Haryana</h1>
  <p>Click nodes to expand/collapse â€¢ Drag background to pan â€¢ Pinch/wheel to zoom â€¢ Double-click to fit.</p>
</header>
<div class="toolbar">
  <button class="btn" id="expandAll">Expand All</button>
  <button class="btn" id="collapseAll">Collapse All</button>
  <button class="btn" id="center">Center View</button>
</div>

<svg id="svg" aria-label="India hierarchy visualization">
  <defs>
    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="3" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>
  </defs>
  <g id="viewport" transform="translate(0,0) scale(1)">
    <!-- Transparent pan layer: receives pan events, not the nodes -->
    <rect id="pan-bg" x="-20000" y="-20000" width="40000" height="40000" fill="transparent" pointer-events="all"></rect>
    <g id="links"></g>
    <g id="nodes"></g>
  </g>
</svg>
<div class="hint">Tip: Click the large blue "India" node to start â€¢ Pinch to zoom on mobile</div>

<script>
/* =========================
   Data
========================= */
const data = {
  name:"India", type:"country", children:[
    {name:"Haryana", type:"state", children:[
      {name:"Kurukshetra", type:"district", children:[
        {name:"Pehowa", type:"tehsil", children:[
          {name:"Kheri Shishgran", type:"village", children:[
            {name:"Anand Agro Farms", type:"business", mapLink:"https://www.google.com/maps/search/?api=1&query=Anand+Agro+Farms+AAF"}
          ]},
          {name:"Pehowa (Urban)", type:"village"},
          {name:"Bhor Saidan", type:"village"}
        ]},
        {name:"Thanesar", type:"tehsil", children:[
          {name:"Thanesar (Urban)", type:"village"},
          {name:"Jhansa", type:"village"}
        ]}
      ]}
    ]}
  ]
};

/* =========================
   Hierarchy + helpers
========================= */
function uid(){ 
  return (crypto && crypto.randomUUID) ? crypto.randomUUID() : 'id-' + Math.random().toString(36).slice(2);
}

function cloneHierarchy(obj, depth=0){
  return { 
    id: uid(), 
    name: obj.name, 
    type: obj.type || "", 
    depth,
    mapLink: obj.mapLink || null,
    children: obj.children ? obj.children.map(c=>cloneHierarchy(c, depth+1)) : null,
    _children: null, 
    x: 0, 
    y: 0
  };
}

const root = cloneHierarchy(data);

// collapse all descendants
function collapse(n){
  if(n.children){
    n._children = n.children;
    n.children = null;
    n._children.forEach(collapse);
  }
}
collapse(root); // start with only India visible

/* =========================
   Layout (fixed)
========================= */
const HORIZONTAL_SPACING = 280;
const VERTICAL_SPACING   = 50;
const LEFT_MARGIN        = 100;
const TOP_MARGIN         = 50;

function computeLayout(root){
  function assignX(node) {
    node.x = LEFT_MARGIN + (node.depth * HORIZONTAL_SPACING);
    (node.children||[]).forEach(assignX);
  }
  assignX(root);

  function assignY(node) {
    const children = node.children || [];
    if (children.length === 0) {
      node.y = assignY.nextY;
      assignY.nextY += VERTICAL_SPACING;
    } else {
      children.forEach(assignY);
      const firstChild = children[0];
      const lastChild = children[children.length - 1];
      node.y = (firstChild.y + lastChild.y) / 2;
    }
  }
  assignY.nextY = TOP_MARGIN;
  assignY(root);
}

function curvePath(x1, y1, x2, y2){
  const midX = (x1 + x2) / 2;
  return `M ${x1},${y1} C ${midX},${y1} ${midX},${y2} ${x2},${y2}`;
}

function colorByType(t){
  return ({
    country: "#64a5ff",
    state: "var(--accent)",
    district: "#eab676",
    tehsil: "#b084f5",
    village: "#f27fa5",
    business: "#ffcc00"
  })[t] || "var(--node)";
}

/* =========================
   Render
========================= */
const svg     = document.getElementById('svg');
const viewport= document.getElementById('viewport');
const panBg   = document.getElementById('pan-bg');
const gLinks  = document.getElementById('links');
const gNodes  = document.getElementById('nodes');

function clear(el){ while(el.firstChild) el.removeChild(el.firstChild); }

function update(){
  computeLayout(root);

  // links
  clear(gLinks);
  (function renderLinks(node){
    const children = node.children || [];
    for(const child of children){
      const path = document.createElementNS("http://www.w3.org/2000/svg","path");
      path.setAttribute("class","link");
      path.setAttribute("d", curvePath(node.x, node.y, child.x, child.y));
      gLinks.appendChild(path);
      renderLinks(child);
    }
    if(node._children && node._children.length){
      const stub = document.createElementNS("http://www.w3.org/2000/svg","path");
      stub.setAttribute("class","link");
      stub.setAttribute("stroke-dasharray","4 4");
      stub.setAttribute("stroke-opacity","0.5");
      stub.setAttribute("stroke-width","2");
      stub.setAttribute("d", curvePath(node.x, node.y, node.x + 60, node.y));
      gLinks.appendChild(stub);
    }
  })(root);

  // nodes
  clear(gNodes);
  (function renderNode(node){
    const g = document.createElementNS("http://www.w3.org/2000/svg","g");
    g.setAttribute("class","node");
    g.setAttribute("transform", `translate(${node.x},${node.y})`);
    g.style.cursor = "pointer";

    // click handler
    g.addEventListener("click",(e)=>{
      e.stopPropagation();
      
      // If this node has a map link, open it
      if(node.mapLink){
        window.open(node.mapLink, '_blank');
        return;
      }
      
      // Otherwise, toggle expand/collapse
      if(node._children && node._children.length){
        node.children = node._children; 
        node._children = null;
      } else if(node.children && node.children.length){
        node._children = node.children; 
        node.children = null;
      }
      update();
    });

    const hasAnyChildren = (node.children && node.children.length) || (node._children && node._children.length);
    const circle = document.createElementNS("http://www.w3.org/2000/svg","circle");
    // Larger circles for better mobile visibility
    circle.setAttribute("r", hasAnyChildren ? "14" : "10");
    circle.setAttribute("fill", colorByType(node.type));
    circle.setAttribute("stroke", "#fff");
    circle.setAttribute("stroke-width", "2");
    g.appendChild(circle);

    const text = document.createElementNS("http://www.w3.org/2000/svg","text");
    text.setAttribute("x", 16);
    text.setAttribute("dy",".35em");
    text.setAttribute("text-anchor", "start");
    text.setAttribute("font-size", "14");
    text.textContent = node.name;
    if(node.mapLink){
      text.setAttribute("class", "external-link");
      text.setAttribute("fill", "#ffcc00");
    }
    g.appendChild(text);

    if(node.type && node.type !== "country"){
      const badge = document.createElementNS("http://www.w3.org/2000/svg","text");
      badge.setAttribute("class","badge");
      badge.setAttribute("x", 16);
      badge.setAttribute("dy","1.8em");
      badge.setAttribute("font-size", "11");
      if(node.type === "business" && node.mapLink){
        badge.textContent = `[5 - 7 acres only for sale]`;
        badge.setAttribute("fill", "#ffcc00");
      } else {
        badge.textContent = `[${node.type}]`;
      }
      g.appendChild(badge);
    }

    if(node._children && node._children.length){
      const indicator = document.createElementNS("http://www.w3.org/2000/svg","text");
      indicator.setAttribute("class","collapsed-indicator");
      indicator.setAttribute("x", 0);
      indicator.setAttribute("y", 0);
      indicator.setAttribute("dy", ".5em");
      indicator.setAttribute("text-anchor", "middle");
      indicator.setAttribute("font-weight", "bold");
      indicator.setAttribute("font-size", "20");
      indicator.textContent = "+";
      g.appendChild(indicator);
    } else if(node.children && node.children.length){
      const indicator = document.createElementNS("http://www.w3.org/2000/svg","text");
      indicator.setAttribute("class","collapsed-indicator");
      indicator.setAttribute("x", 0);
      indicator.setAttribute("y", 0);
      indicator.setAttribute("dy", ".4em");
      indicator.setAttribute("text-anchor", "middle");
      indicator.setAttribute("font-weight", "bold");
      indicator.setAttribute("font-size", "22");
      indicator.textContent = "âˆ’";
      g.appendChild(indicator);
    }

    gNodes.appendChild(g);
    (node.children||[]).forEach(renderNode);
  })(root);
}

update();

/* =========================
   Pan & zoom (background only)
========================= */
let tz = 1, tx = 0, ty = 0;
// Save view during session, but always start centered on page load
const VIEW_KEY = 'indiaExplorerView';
let _saveTO = null;
let initialLoadComplete = false;

function saveView(){
  // Only save after initial load is complete
  if(!initialLoadComplete) return;
  try { localStorage.setItem(VIEW_KEY, JSON.stringify({tx,ty,tz})); } catch {}
}
function scheduleSave(){
  clearTimeout(_saveTO);
  _saveTO = setTimeout(saveView, 150);
}
function applyTransform(){
  viewport.setAttribute("transform", `translate(${tx},${ty}) scale(${tz})`);
  scheduleSave();
}

// Wheel zoom on the SVG
svg.addEventListener("wheel",(e)=>{
  e.preventDefault();
  const rect = svg.getBoundingClientRect();
  const mx = e.clientX - rect.left;
  const my = e.clientY - rect.top;
  const scale = Math.exp(-e.deltaY * 0.0015);
  const newZ = Math.min(2.5, Math.max(0.3, tz * scale));
  tx = mx - (mx - tx) * (newZ / tz);
  ty = my - (my - ty) * (newZ / tz);
  tz = newZ;
  applyTransform();
},{passive:false});

// Pan only when pointer is on the transparent background (not nodes)
let dragging=false, px=0, py=0;
panBg.addEventListener("pointerdown",(e)=>{
  dragging = true;
  px = e.clientX;
  py = e.clientY;
  panBg.setPointerCapture(e.pointerId);
});
panBg.addEventListener("pointermove",(e)=>{
  if(!dragging) return;
  tx += (e.clientX - px);
  ty += (e.clientY - py);
  px = e.clientX;
  py = e.clientY;
  applyTransform();
});
panBg.addEventListener("pointerup",(e)=>{
  if(!dragging) return;
  dragging = false;
  try { panBg.releasePointerCapture(e.pointerId); } catch {}
});

// Double-click background to fit
svg.addEventListener("dblclick",(e)=>{
  // ignore dblclicks that originate on nodes (they bubble to svg)
  if (e.target.closest('.node')) return;
  fitToScreen();
});

function fitToScreen(){
  const bb = viewport.getBBox();
  const vw = svg.clientWidth;
  const vh = svg.clientHeight;
  if (!bb || !isFinite(bb.width) || !isFinite(bb.height)) return;
  
  // Calculate scale to fit content with padding
  const scaleX = (vw * 0.5) / bb.width;
  const scaleY = (vh * 0.5) / bb.height;
  const scale = Math.max(0.5, Math.min(2.5, Math.min(scaleX, scaleY)));
  
  tz = scale;
  
  // Center the content in viewport
  const scaledWidth = bb.width * scale;
  const scaledHeight = bb.height * scale;
  const centerX = bb.x + bb.width / 2;
  const centerY = bb.y + bb.height / 2;
  
  tx = vw / 2 - centerX * scale;
  ty = vh / 2 - centerY * scale;
  
  applyTransform();
}

// initial view: ALWAYS center on first load, ignore saved view
setTimeout(() => {
  fitToScreen();
  initialLoadComplete = true; // Now start saving view changes
  console.log('ðŸŽ¯ India node centered on screen');
}, 100);

/* =========================
   Controls
========================= */
document.getElementById("expandAll").onclick = ()=>{
  (function expandAll(n){
    if(n._children){ n.children = n._children; n._children = null; }
    (n.children||[]).forEach(expandAll);
  })(root);
  update();
  setTimeout(fitToScreen, 50);
};

document.getElementById("collapseAll").onclick = ()=>{
  (root.children||[]).forEach(collapse);
  update();
  setTimeout(fitToScreen, 50);
};

document.getElementById("center").onclick = fitToScreen;
</script>
</body>
</html>
